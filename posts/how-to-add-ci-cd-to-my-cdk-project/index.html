<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="How to add CI/CD to my CDK project" /><meta property="og:locale" content="en" /><meta name="description" content="I will show you how you can deploy a CDK project using the Developer Tools of AWS, and a different approach to creating it with AWS console and with IaC." /><meta property="og:description" content="I will show you how you can deploy a CDK project using the Developer Tools of AWS, and a different approach to creating it with AWS console and with IaC." /><link rel="canonical" href="https://www.playingaws.com//posts/how-to-add-ci-cd-to-my-cdk-project/" /><meta property="og:url" content="https://www.playingaws.com//posts/how-to-add-ci-cd-to-my-cdk-project/" /><meta property="og:site_name" content="Playing AWS" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-26T02:03:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to add CI/CD to my CDK project" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-29T00:04:03+02:00","datePublished":"2022-03-26T02:03:00+01:00","description":"I will show you how you can deploy a CDK project using the Developer Tools of AWS, and a different approach to creating it with AWS console and with IaC.","headline":"How to add CI/CD to my CDK project","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.playingaws.com//posts/how-to-add-ci-cd-to-my-cdk-project/"},"url":"https://www.playingaws.com//posts/how-to-add-ci-cd-to-my-cdk-project/"}</script><title>How to add CI/CD to my CDK project | Playing AWS</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Playing AWS"><meta name="application-name" content="Playing AWS"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/favicons/favicon.ico" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Playing AWS</a></div><div class="site-subtitle font-italic">Learn, remove barriers and practice</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://www.linkedin.com/in/alejandro-lazaro-chueca/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://github.com/alazaroc" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>How to add CI/CD to my CDK project</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"> <img src="/assets/img/header.jpeg" alt="header"><h1 data-toc-skip>How to add CI/CD to my CDK project</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1648256580" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 26, 2022 </em> </span> <span> Updated <em class="" data-ts="1685311443" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 29, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/alejandro-lazaro-chueca/">Alejandro Lazaro</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2735 words"> <em>15 min</em> read</span></div></div></div><div class="post-content"><hr /><h2 id="tldr"><span class="mr-2">TLDR</span><a href="#tldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I already have a CDK project on GitHub <a href="https://github.com/alazaroc/blog-backend-infrastructure/" target="_blank">here</a>, but to deploy it I have to run the CDK Toolkit command <code class="language-plaintext highlighter-rouge">cdk deploy</code> from my local machine.</p><p>I want <strong>to add automation</strong> to my deployment process and integrate it with the AWS ecosystem… so <strong>I will use the AWS Developer tools</strong> to do it.</p><p>I will show you 2 different approaches:</p><ul><li><strong>Create the pipeline with the AWS Console</strong>: Why? Helps you understand the low level of the solution and how AWS services work<li><strong>Create the pipeline with IaC (CDK)</strong>: Why? You should always try to automate everything. In this case, I will create the pipeline that will allow us to deploy the CDK code automatically.</ul><p>I want to implement the simplest solution, with the KISS principle in mind, and for this reason, my architecture diagram is as follows:</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/architecture-diagrams/solution-1.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/architecture-diagrams/solution-1.png" alt="solution-1" class="lazyload" data-proofer-ignore></a></p><p>Explanation: In a CDK deployment, I don’t need to run the <code class="language-plaintext highlighter-rouge">cdk synth</code> command and manage the generated artifacts, so the simplest solution is to run the <code class="language-plaintext highlighter-rouge">cdk deploy</code> command directly.</p><blockquote class="prompt-info"><div><p>If you need more information about it, I wrote a related post: <a href="/posts/how-to-create-infrastructure-with-cdk/" target="_blank">How to create infrastructure with CDK</a>.</p></div></blockquote><p>However, upon investigation the AWS recommendation to deploy a CI/CD pipeline of CDK projects is something similar to the following:</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/architecture-diagrams/solution-2.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/architecture-diagrams/solution-2.png" alt="solution-2" class="lazyload" data-proofer-ignore></a></p><p>I will explain it in detail in this post.</p><blockquote class="prompt-info"><div><p>I have preferred to include all of information in the same post, although I could easily split it in 2 or 3, and this post have a lot of content and images.</p></div></blockquote><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Before I start showing you how to add the CI/CD I will introduce you to the basic concepts involved:</p><p>SDLC (<strong>Software Development Lifecycle</strong>)</p><blockquote><p>is a process for planning, creating, testing, and deploying an information system - Wikipedia</p></blockquote><p>Depending on where you look, there will be a different number of phases in the SDLC process.</p><p>For this article we will explain what means CI/CD over 4 phases of the software release process: source, build, test and production (deployment):</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/software-release-process.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/software-release-process.png" alt="software-release-process" class="lazyload" data-proofer-ignore></a></p><p><strong>CI/CD</strong> refers to Continuous Integration and Continuous Delivery and it introduces automation and monitoring to the complete SDLC.</p><p><strong>Continuous integration (CI)</strong> is a software development practice where developers regularly merge their code changes into a central repository, after which automated builds and tests are run</p><ul><li>The key goals of CI are<ul><li>to find and address bugs more quickly,<li>improve software quality,<li>and reduce the time it takes to validate and release new software updates</ul><li>Continuous integration focuses on smaller commits and smaller code changes to integrate</ul><p><strong>Continuous delivery (CD)</strong> is a software development practice where code changes are automatically built, tested, and prepared for production release</p><ul><li>Benefits<ul><li>Automate the software release process<li>Improve developer productivity<li>Improve code quality<li>Deliver updates faster</ul><li>The point of continuous delivery is not to apply every change to production immediately but to ensure that every change is ready to go to production</ul><p><strong>Continuous deployment (CD)</strong>, revisions are deployed to a production environment automatically without explicit approval from a developer, making the entire software release process automated.</p><blockquote class="prompt-tip"><div><p>So yes, the <strong>“CD”</strong> in “CI/CD” means 2 different things:</p><ul><li>Continuos Delivery (prepare deployment to prod)<li>and Continuos Deployment (deploy automatically in prod)</ul></div></blockquote><h2 id="codepipeline-for-cdk-with-aws-console"><span class="mr-2">CodePipeline for CDK with AWS Console</span><a href="#codepipeline-for-cdk-with-aws-console" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First, we will create the solution with the AWS Console because it helps to understand how the services involved work.</p><p>As we want to create a new Pipeline, we must access to <kbd>CodePipeline</kbd> service and click on <kbd>Create pipeline</kbd>.</p><p>Step 1 in CodePipeline is to choose the pipeline settings. We have to create a new service role (or use an existing one).</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-1.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-1.png" alt="codepipeline1" class="lazyload" data-proofer-ignore></a></p><p>Step 2 is to add the source of the stage choosing the source provider. I have my code repository on GitHub so I choose GitHub (version 2) but you could choose a different one.</p><blockquote class="prompt-tip"><div><p>There are 2 options for GitHub source provider:</p><ul><li>version 1 (not recommended) which uses OAuth apps to access your GitHub repository<li><strong>version 2 (recommended)</strong> which uses a connection with GitHub Apps to access your repository</ul></div></blockquote><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-2.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-2.png" alt="codepipeline2" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-info"><div><p>If you choose GitHub version 2, the next step is to <strong>create a new connection</strong> to GitHub and if you don’t have any GitHub App created you need to create a new one, so you should click on <kbd>Install new app</kbd>.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-3.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-3.png" alt="codepipeline3" class="lazyload" data-proofer-ignore></a></p><p>You have to choose whether to create the connection for all repositories or only th selected ones, and click <kbd>Install</kbd>.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-4.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-4.png" alt="codepipeline4" class="lazyload" data-proofer-ignore></a></p><p>The GitHub connection is ready to use and you will be redirected to Step 2 of the creation of the CodePipeline.</p></div></blockquote><p>Now you can choose your repository and your branch and click on <kbd>Next</kbd>.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-5.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-5.png" alt="codepipeline5" class="lazyload" data-proofer-ignore></a></p><p>Step 3 is to add the build stage, and you should select <kbd>AWS CodeBuild</kbd> because we want to use this service to add custom commands.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-6-build.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-6-build.png" alt="codepipeline6" class="lazyload" data-proofer-ignore></a></p><p>After that, select the region, a project name, and a single build and click <kbd>Next</kbd>.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-7-build.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-7-build.png" alt="codepipeline7" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-danger"><div><p>With this specific configuration, it will fail, do you know why?</p></div></blockquote><p>Step 4 is to add the deploy stage. Here are all the available options but we <kbd>skip</kbd> this step because we don’t need it.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-8-deploy.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-8-deploy.png" alt="codepipeline8" class="lazyload" data-proofer-ignore></a></p><p>Now the CodePipeline is ready to be created and a review page is displayed. Confirm and create the CodePipeline.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-9.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-9.png" alt="codepipeline9" class="lazyload" data-proofer-ignore></a></p><p>It is done. We have created the CodePipeline and added 2 stages:</p><ul><li>Source<li>Build</ul><p>First execution…</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-10.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-10.png" alt="codepipeline10" class="lazyload" data-proofer-ignore></a></p><p>As you can see the execution had failed!</p><p>Do you know what caused the error? Let’s investigate it…</p><p>If you click on the <code class="language-plaintext highlighter-rouge">execution ID link</code>, you will be redirected to the pipeline execution summary and you will see the error message <code class="language-plaintext highlighter-rouge">Project cannot be found</code> in CodeBuild.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-11.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-11.png" alt="codepipeline11" class="lazyload" data-proofer-ignore></a></p><p>Also, you can click on the <kbd>AWS CodeBuild</kbd> action name and you will be redirected to the CodeBuild service… where you will receive the same error information: “Resource not available”.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-12.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-12.png" alt="codepipeline12" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-warning"><div><p>Yes, there is no CodeBuild project created in the pipeline, we just add a name of a created CodeBuild resource (and this resource doesn’t exist because <strong>nobody has created it</strong>).</p></div></blockquote><p>To fix it, you need to <kbd>edit the Pipeline</kbd> and <kbd>edit the Build stage</kbd> to create a new CodeBuild project.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-15.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-15.png" alt="codepipeline15" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-16.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-16.png" alt="codepipeline16" class="lazyload" data-proofer-ignore></a></p><p>A new window will be opened, the Build stage will be editable and you need to click on the <kbd>Create project</kbd> button.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-17.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-17.png" alt="codepipeline17" class="lazyload" data-proofer-ignore></a></p><p>You can create the build project by choosing the following:</p><ul><li>Operating System: <code class="language-plaintext highlighter-rouge">Amazon Linux 2</code><li>Runtime(s): <code class="language-plaintext highlighter-rouge">Standard</code><li>Image: the more updated image<li>New role name<li><p>Buildspec: <code class="language-plaintext highlighter-rouge">Insert build commands</code> and click to <kbd>Switch to editor</kbd> and add the following:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>version: 0.2
phases:
  <span class="nb">install</span>:
    commands:
      - npm <span class="nb">install</span>
      - npm <span class="nb">install</span> <span class="nt">-g</span> typescript
      - npm <span class="nb">install</span> <span class="nt">-g</span> aws-cdk
  build:
    commands:
      - npm ci
      - npm run build
      - cdk deploy
</pre></table></code></div></div><li>Add a CloudWatch log, choosing as Group name <code class="language-plaintext highlighter-rouge">/aws/codebuild/blog-backend-infrastructure</code></ul><p>When you have finished filling in all fields, click <kbd>Continue to CodePipeline</kbd>.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-18-create-codebuild.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-18-create-codebuild.png" alt="codepipeline18" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-19.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-19.png" alt="codepipeline19" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-danger"><div><p>Again, with this configuration the execution will fail. Do you know why?</p></div></blockquote><p>You can now go back to the CodePipeline and force the execution again by clicking on <kbd>Release change</kbd>.</p><p>And, as expected, it fails again.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-14-error.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-14-error.png" alt="codepipeline14-error2" class="lazyload" data-proofer-ignore></a></p><p>This time we will review the <strong>CloudWatch logs</strong> generated for this run to look for errors.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-21.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-21.png" alt="codepipeline21" class="lazyload" data-proofer-ignore></a></p><p>You can see that the <strong>CodeBuild role</strong> is trying to assume the CDK role to perform the CDK commands, and of course, we didn’t specify any permissions to the new role so it can’t assume any roles.</p><blockquote class="prompt-tip"><div><p><strong>How CDK deploy works</strong>: Behind the scenes, when the <code class="language-plaintext highlighter-rouge">cdk deploy</code> command is executed, CDK is using the CDK roles created in the bootstrap process to perform some actions: perform a lookup, upload files and deploy the template uploaded in the S3 into the CloudFormation service.</p></div></blockquote><p>Therefore, you need to update the CodeBuild role to add the assumed permission to CDK roles. To do this, create new permission (new inline policy).</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-22-edit-role.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-22-edit-role.png" alt="codepipeline22" class="lazyload" data-proofer-ignore></a></p><p>You must add the Action <code class="language-plaintext highlighter-rouge">sts:AssumeRole</code> and the Resources of the 4 CDK roles created in the bootstrap.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-23.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-23.png" alt="codepipeline23" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-24.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-24.png" alt="codepipeline24" class="lazyload" data-proofer-ignore></a></p><p>When is created, you can review that the new permission has been added to the CodeBuild role.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-25.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-25.png" alt="codepipeline25" class="lazyload" data-proofer-ignore></a></p><p>If you come back to the CodePipeline service and you execute it again, it will succeed!</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-26.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-26.png" alt="codepipeline26" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-note"><div><p>Now, if you make any changes in your repository, <strong>the pipeline will be automatically executed</strong> and your infrastructure will be updated executing the <code class="language-plaintext highlighter-rouge">cdk deploy</code> command of the CDK Toolkit inside of the CodeBuild service.</p></div></blockquote><p>If you want, you can check the logs in the <strong>CloudWatch</strong> service to verify that the execution of the <code class="language-plaintext highlighter-rouge">cdk deploy</code> command went as we expected:</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-27.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-27.png" alt="codepipeline27" class="lazyload" data-proofer-ignore></a></p><h3 id="improve-use-a-buildspec-file-inside-the-code"><span class="mr-2">Improve: Use a Buildspec file inside the code</span><a href="#improve-use-a-buildspec-file-inside-the-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>You have done a lot of manual work, and the first improvement you can <strong>automate</strong> is the definition of the build process itself.</p><p>You need to update, in the CodeBuild project, the buildspec configuration of the project, select <code class="language-plaintext highlighter-rouge">Use a buildspec file</code> and click to <kbd>Update buildspec</kbd>.</p><p>Now <strong>when the pipeline runs it will look for the buildspec file inside the code</strong> (in the root folder). You have configured the CodeBuild service but you don’t have the buildspec.yml file added to your code yet.</p><p>Next, you must add the buildspec.yml file with the same content you provided in the online editor to update the build commands in the code. <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html#build-spec-ref-name-storage" target="_blank">More information about buildspec file</a></p><p>In the following image, you can see the VSCode IDE and the new <kbd>buildspec.yml</kbd> file with the same content as before.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-29.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-29.png" alt="codepipeline29" class="lazyload" data-proofer-ignore></a></p><h3 id="test-it-automatic-execution-of-the-pipeline-when-a-commit-is-done"><span class="mr-2">Test it: automatic execution of the pipeline when a commit is done</span><a href="#test-it-automatic-execution-of-the-pipeline-when-a-commit-is-done" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If you commit the new file to your repository (buildspec.yml)</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-30.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-30.png" alt="codepipeline30" class="lazyload" data-proofer-ignore></a></p><p>The <strong>pipeline runs automatically</strong> as expected</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-31.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/console/codepipeline-31.png" alt="codepipeline31" class="lazyload" data-proofer-ignore></a></p><h2 id="codepipeline-for-cdk-with-iac"><span class="mr-2">CodePipeline for CDK with IaC</span><a href="#codepipeline-for-cdk-with-iac" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that we have deployed the CodePipeline with the AWS Console, <strong>we will do the same with Infrastructure as Code</strong> with CDK.</p><p>To do this, I will add a CodePipeline resource to my CDK project for the blog.</p><blockquote class="prompt-warning"><div><p>I am using the GitHub v2 connection because it is the recommended way, and it requires first to use the AWS Console to authenticate to the source control provider, and then use the connection ARN in your pipeline definition.</p><p>In other words, <strong>if you use GitHub v2 you need create the connection manually</strong>!</p></div></blockquote><h3 id="selfmutation-property"><span class="mr-2">Selfmutation property</span><a href="#selfmutation-property" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote class="prompt-info"><div><p>I want to show you first how “selfmutation” works in CDK pipelines because this it is important to know.</p></div></blockquote><p>This is the code to add the CodePipeline resource with 2 stages:</p><ul><li>Source with GitHub v2 (with a connection)<li>Build phase (<code class="language-plaintext highlighter-rouge">cdk synth</code>)</ul><blockquote class="prompt-tip"><div><p>CDK pipelines will generate CodeBuild projects for each <strong>ShellStep</strong> you use</p></div></blockquote><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">codePipelineName</span> <span class="o">=</span> <span class="s2">`blog-backend-infrastructure-cdk`</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">pipeline</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CodePipeline</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">codePipelineName</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">pipelineName</span><span class="p">:</span> <span class="nx">codePipelineName</span><span class="p">,</span>
  <span class="na">synth</span><span class="p">:</span> <span class="k">new</span> <span class="nc">ShellStep</span><span class="p">(</span><span class="dl">'</span><span class="s1">Synth</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="c1">// input: CodePipelineSource.gitHub('alazaroc/aws-cdk-pipeline', 'main'),</span>
    <span class="na">input</span><span class="p">:</span> <span class="nx">CodePipelineSource</span><span class="p">.</span><span class="nf">connection</span><span class="p">(</span>
      <span class="dl">'</span><span class="s1">alazaroc/blog-backend-infrastructure</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">main</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="na">connectionArn</span><span class="p">:</span>
          <span class="dl">'</span><span class="s1">arn:aws:codestar-connections:eu-west-1:xxxxxxxx:connection/fb936fb8-a047-43d5-90bd-xxxxxxxxxx</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// Created using the AWS console * });',</span>
      <span class="p">},</span>
    <span class="p">),</span>
    <span class="na">commands</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">npm ci</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">npm run build</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">npx cdk synth</span><span class="dl">'</span><span class="p">],</span>
  <span class="p">}),</span>
<span class="p">});</span>
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>You must <strong>deploy the pipeline manually once</strong>. After that, the pipeline will be kept up to date from the source code repository.</p></div></blockquote><p>If you run the <code class="language-plaintext highlighter-rouge">cdk deploy</code> command, as you can see the pipeline is created and automatically runs.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-1.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-1.png" alt="cdk-codepipeline-1" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-2.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-2.png" alt="cdk-codepipeline-2" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-warning"><div><p>But wait a minute, we have three stages? A new one <code class="language-plaintext highlighter-rouge">SelfMutate</code> appears. Well, let’s wait to finish…</p></div></blockquote><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-3.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-3.png" alt="cdk-codepipeline-3" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-danger"><div><p>PipelineNotFoundException? What happened here? We waited for the pipeline to finish executing and the pipeline no longer exists!</p></div></blockquote><p>Let’s do some research on <code class="language-plaintext highlighter-rouge">SelfMutate</code>. The CDK documentation says:</p><blockquote><p>Whether the pipeline will update itself</p><p>This needs to be set to <code class="language-plaintext highlighter-rouge">true</code> to allow the pipeline to reconfigure itself when assets or stages are being added to it, and <code class="language-plaintext highlighter-rouge">true</code> is the recommended setting.</p><p>You can temporarily set this to <code class="language-plaintext highlighter-rouge">false</code> while you are iterating on the pipeline itself and prefer to deploy changes using <code class="language-plaintext highlighter-rouge">cdk deploy</code>.</p></blockquote><p>We haven’t added this property to our code and the default value applied is <code class="language-plaintext highlighter-rouge">true</code>, so the pipeline has updated itself and, as <strong>the code is NOT committed</strong> in the source code, the pipeline has been removed.</p><p>We have previously executed the deploy command but not a previous commit.</p><blockquote class="prompt-info"><div><p>I didn’t commit my CodePipeline code to make the result “more dramatic” (pipeline deleted automatically). But i<strong>f you commit the code, nothing will happen</strong>. You will have one more stage to allow the pipeline to autoconfigure if there any changes, and at each run this will be checked.</p></div></blockquote><p>I want to show you what will happen if you set the <code class="language-plaintext highlighter-rouge">selfmutate</code> property to false (and the code is not committed).</p><p>This is the change needed in the CDK CodePipeline resource code, adding this line:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">selfMutation</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</pre></table></code></div></div><p>And if you run the <code class="language-plaintext highlighter-rouge">cdk deploy</code> command again, the pipeline will be updated:</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-4.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-4.png" alt="cdk-codepipeline-4" class="lazyload" data-proofer-ignore></a></p><p>Now, there are only 2 stages in the CodePipeline, the <kbd>Source</kbd> and the <kbd>Build</kbd>, the 2 that we have configured and work perfectly.</p><h3 id="cdk-deploy"><span class="mr-2">CDK Deploy</span><a href="#cdk-deploy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We will change the code of our CodePipeline service so that instead of executing a <code class="language-plaintext highlighter-rouge">cdk synth</code> command, it will execute the <code class="language-plaintext highlighter-rouge">cdk deploy</code> command.</p><p>Also, to avoid the assumed role error we saw in the AWS Console example (in this same post), we will add the IAM permissions necessary to the CodeDeploy role to run the deploy command.</p><blockquote class="prompt-tip"><div><p><strong>To customize</strong> the CodeBuild project, <strong>change ShellStep by CodeBuildStep</strong>. This class has more properties to customize it:</p></div></blockquote><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">codePipelineName</span> <span class="o">=</span> <span class="s2">`blog-backend-infrastructure-cdk`</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">pipeline</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CodePipeline</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">codePipelineName</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">pipelineName</span><span class="p">:</span> <span class="nx">codePipelineName</span><span class="p">,</span>
    <span class="c1">// synth: new ShellStep('Deploy', {</span>
    <span class="na">synth</span><span class="p">:</span> <span class="k">new</span> <span class="nc">CodeBuildStep</span><span class="p">(</span><span class="dl">'</span><span class="s1">Deploy</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">input</span><span class="p">:</span> <span class="nx">CodePipelineSource</span><span class="p">.</span><span class="nf">connection</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">alazaroc/aws-cdk-pipeline</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">main</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">{</span>
          <span class="na">connectionArn</span><span class="p">:</span>
            <span class="dl">'</span><span class="s1">arn:aws:codestar-connections:eu-west-1:xxxxxx:connection/4d6c1902-bda7-43fb-8508-xxxxxx</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">),</span>
      <span class="na">commands</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">npm ci</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">npm run build</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">npx cdk deploy --require-approval never</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">rolePolicyStatements</span><span class="p">:</span> <span class="p">[</span>
        <span class="k">new</span> <span class="nx">aws_iam</span><span class="p">.</span><span class="nc">PolicyStatement</span><span class="p">({</span>
          <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">sts:AssumeRole</span><span class="dl">'</span><span class="p">],</span>
          <span class="na">resources</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">],</span>
          <span class="na">conditions</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">StringEquals</span><span class="p">:</span> <span class="p">{</span>
              <span class="dl">'</span><span class="s1">iam:ResourceTag/aws-cdk:bootstrap-role</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span>
                <span class="dl">'</span><span class="s1">lookup</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">image-publishing</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">file-publishing</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">deploy</span><span class="dl">'</span><span class="p">,</span>
              <span class="p">],</span>
            <span class="p">},</span>
          <span class="p">},</span>
        <span class="p">}),</span>
      <span class="p">],</span>
    <span class="p">}),</span>
    <span class="na">selfMutation</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">});</span>
</pre></table></code></div></div><p>When you deploy it will create the CodePipeline project and execute the 2 steps defined:</p><ul><li>Source<li>Build (<code class="language-plaintext highlighter-rouge">cdk deploy</code>)</ul><blockquote class="prompt-info"><div><p>We changed the <code class="language-plaintext highlighter-rouge">cdk synth</code> by <code class="language-plaintext highlighter-rouge">cdk deploy</code> and also added the necessary permissions.</p></div></blockquote><p>And since we have added the appropriate permissions, it doesn’t fail.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-5.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-5.png" alt="cdk-codepipeline-5" class="lazyload" data-proofer-ignore></a></p><h3 id="recommended-deployment-of-codepipeline-to-cdk-projects"><span class="mr-2">Recommended deployment of CodePipeline to CDK projects</span><a href="#recommended-deployment-of-codepipeline-to-cdk-projects" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote class="prompt-warning"><div><p>This approach is a little different.</p></div></blockquote><p>I will use <a href="https://github.com/alazaroc/aws-cdk-pipeline" target="_blank">this other example of CodePipeline for CDK</a>, to make it easier to understand. Also, I will go step by step to understand perfectly how it works.</p><p>This is the final diagram of what we will build (with the CDK code):</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-pipeline-diagram.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-pipeline-diagram.png" alt="cdk-pipeline-diagram" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-info"><div><p>If you want to create the Pipeline of the CDK project you will need to include at least two stacks: one for the pipeline and one or more for the infrastructure that will be deployed with the pipeline.</p></div></blockquote><p>Application deployment begins by defining <strong>MyPipelineAppStage</strong>, a subclass of <code class="language-plaintext highlighter-rouge">Stage</code> that contains the stacks that make up a single copy of my stack (MyIaCStack).</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">class</span> <span class="nc">MyPipelineAppStage</span> <span class="kd">extends</span> <span class="nc">Stage</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">?:</span> <span class="nx">StageProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">iaCStack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyIaCStack</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">iac-example-stack</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">description</span><span class="p">:</span>
        <span class="dl">'</span><span class="s1">Stack created with codepipeline in the example aws-cdk-pipeline</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now, we define <strong>MyIaCStack</strong>, which contains all the AWS resources that will be created in a different stack than Pipeline:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">class</span> <span class="nc">MyIaCStack</span> <span class="kd">extends</span> <span class="nc">Stack</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">?:</span> <span class="nx">StackProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

    <span class="c1">// Add resources</span>
    <span class="k">new</span> <span class="nx">aws_s3</span><span class="p">.</span><span class="nc">Bucket</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">MyFirstBucket</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">enforceSSL</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Finally, we create the main stack, <strong>MyPipelineStack</strong>, which will add <strong>MyPipelineAppStage</strong> as a stage within the CodePipeline resource.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">class</span> <span class="nc">MyPipelineStack</span> <span class="kd">extends</span> <span class="nc">Stack</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">?:</span> <span class="nx">StackProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">codePipelineName</span> <span class="o">=</span> <span class="s2">`test-iac-with-cdk`</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">pipeline</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CodePipeline</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">codePipelineName</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">pipelineName</span><span class="p">:</span> <span class="nx">codePipelineName</span><span class="p">,</span>
      <span class="na">synth</span><span class="p">:</span> <span class="k">new</span> <span class="nc">ShellStep</span><span class="p">(</span><span class="dl">'</span><span class="s1">Synth</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="c1">// input: CodePipelineSource.gitHub('alazaroc/aws-cdk-pipeline', 'main'),</span>
        <span class="na">input</span><span class="p">:</span> <span class="nx">CodePipelineSource</span><span class="p">.</span><span class="nf">connection</span><span class="p">(</span>
          <span class="dl">'</span><span class="s1">alazaroc/aws-cdk-pipeline</span><span class="dl">'</span><span class="p">,</span>
          <span class="dl">'</span><span class="s1">main</span><span class="dl">'</span><span class="p">,</span>
          <span class="p">{</span>
            <span class="na">connectionArn</span><span class="p">:</span> <span class="nf">getMyGitHubConnectionFromSsmParameterStore</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="c1">// Created using the AWS console * });',</span>
          <span class="p">},</span>
        <span class="p">),</span>
        <span class="na">commands</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">npm ci</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">npm run build</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">npx cdk synth</span><span class="dl">'</span><span class="p">],</span>
      <span class="p">}),</span>
    <span class="p">});</span>

    <span class="nx">pipeline</span><span class="p">.</span><span class="nf">addStage</span><span class="p">(</span>
      <span class="k">new</span> <span class="nc">MyPipelineAppStage</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Deploy</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="c1">// env: { account: "111111111111", region: "eu-west-1" }</span>
      <span class="p">}),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We have to <strong>commit</strong> all the above changes, <strong>and</strong> after that <strong>deploy</strong> it.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-7.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-7.png" alt="cdk-codepipeline-7" class="lazyload" data-proofer-ignore></a></p><p>It will create:</p><ul><li>the main stack with the CodePipeline, <strong>MyPipelineStack</strong>,<li>the <strong>Deploy-iacStack</strong></ul><p>First, the pipeline stack is created, and then, when the CodePipeline is executed, the second stack which contains all the other resources is created.</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-6.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-6.png" alt="cdk-codepipeline-6" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-8.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/iac/cdk-codepipeline-8.png" alt="cdk-codepipeline-8" class="lazyload" data-proofer-ignore></a></p><p>That is all, we have automation in our deployment process!</p><p>So as you can see, using CDK’s CodePipeline constructor, the following is created:</p><p><a href="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/architecture-diagrams/solution-2.png" class="popup img-link border"><img data-src="/assets/img/posts/2022-03-20-how-to-add-ci-cd-to-my-cdk-project/architecture-diagrams/solution-2.png" alt="solution-2" class="lazyload" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devops/'>DevOps</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/how-to/" class="post-tag no-text-decoration" >how-to</a> <a href="/tags/iac/" class="post-tag no-text-decoration" >iac</a> <a href="/tags/cdk/" class="post-tag no-text-decoration" >cdk</a> <a href="/tags/cicd/" class="post-tag no-text-decoration" >cicd</a> <a href="/tags/codepipeline/" class="post-tag no-text-decoration" >codepipeline</a> <a href="/tags/codebuild/" class="post-tag no-text-decoration" >codebuild</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How%20to%20add%20CI/CD%20to%20my%20CDK%20project%20-%20Playing%20AWS&url=https%3A%2F%2Fwww.playingaws.com%2F%2Fposts%2Fhow-to-add-ci-cd-to-my-cdk-project%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.playingaws.com%2F%2Fposts%2Fhow-to-add-ci-cd-to-my-cdk-project%2F&text=How%20to%20add%20CI/CD%20to%20my%20CDK%20project%20-%20Playing%20AWS" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.playingaws.com%2F%2Fposts%2Fhow-to-add-ci-cd-to-my-cdk-project%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading"></div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/aws-open-source-tools/">Getting started with AWS open-source tools</a><li><a href="/posts/getting-started-with-aws-security/">Getting Started with AWS Security</a><li><a href="/posts/how-to-improve-your-account-security/">How to improve your account security</a></ul></div><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/challenge-data-certification-in-30-days/">Challenge: 'AWS Certified Data Analytics Specialty' in 30 days</a><li><a href="/posts/10-steps-to-prepare-any-aws-certification/">10 steps to prepare any AWS certification</a><li><a href="/posts/aws-control-tower-deep-dive/">AWS Control Tower Deep Dive</a><li><a href="/posts/the-technology-behind-this-blog/">How I decided on the technology behind the blog</a><li><a href="/posts/multi-account-approach/">Getting started with AWS Multi-account approach</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/how-to/">how-to</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/iac/">iac</a> <a class="post-tag" href="/tags/getting-started/">getting-started</a> <a class="post-tag" href="/tags/cdk/">cdk</a> <a class="post-tag" href="/tags/deep-dive/">deep dive</a> <a class="post-tag" href="/tags/serverless/">serverless</a> <a class="post-tag" href="/tags/certification/">certification</a> <a class="post-tag" href="/tags/open-source/">open-source</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/how-to-add-ci-cd-to-my-sam-project/"><div class="card-body"> <em class="small" data-ts="1649580780" data-df="ll" > Apr 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to add CI/CD to my SAM project</h3><div class="text-muted small"><p> Introduction This is the second article of SAM. In this other article I had explained how to create serverless applications with SAM, and there I explained all the basic SAM information, so y...</p></div></div></a></div><div class="card"> <a href="/posts/how-to-create-infrastructure-with-cdk/"><div class="card-body"> <em class="small" data-ts="1647455280" data-df="ll" > Mar 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to create infrastructure with CDK</h3><div class="text-muted small"><p> TLDR I will explain the basics of CDK in practice: how CDK works and how to deploy a CDK project from scratch. In addition, I will share the source code of my CDK project used to create the inf...</p></div></div></a></div><div class="card"> <a href="/posts/how-to-create-serverless-applications-with-cdk-and-sam/"><div class="card-body"> <em class="small" data-ts="1650912300" data-df="ll" > Apr 25, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to create serverless applications with CDK and SAM</h3><div class="text-muted small"><p> TLDR A serverless application is more than just a Lambda Function. It is a combination of Lambda functions, event sources, APIs, databases, and other resources that work together to perform t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/how-to-create-infrastructure-with-cdk/" class="btn btn-outline-primary" prompt="Older"><p>How to create infrastructure with CDK</p></a> <a href="/posts/how-to-create-serverless-applications-with-sam/" class="btn btn-outline-primary" prompt="Newer"><p>How to create serverless applications with SAM</p></a></div><script type="text/javascript"> document.getElementsByClassName("post-content")[0].innerHTML += '<h2 id="comment-this-post">Comment this post</h2>'; document.getElementsByClassName("post-content")[0].innerHTML += '<p>I hope this content has been relevant to you. To help me improve it would be helpful if you could give me your honest feedback.</p>'; $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "alazaroc/blog-web", "data-repo-id": "R_kgDOHA-hqQ", "data-category": "Announcements", "data-category-id": "DIC_kwDOHA-hqc4CT2E5", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementsByClassName("post-content")[0].appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/how-to/">how-to</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/iac/">iac</a> <a class="post-tag" href="/tags/getting-started/">getting-started</a> <a class="post-tag" href="/tags/cdk/">cdk</a> <a class="post-tag" href="/tags/deep-dive/">deep dive</a> <a class="post-tag" href="/tags/serverless/">serverless</a> <a class="post-tag" href="/tags/certification/">certification</a> <a class="post-tag" href="/tags/open-source/">open-source</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://www.linkedin.com/in/alejandro-lazaro-chueca/">Alejandro Lazaro</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Deployed with AWS resources.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-HW1NDPDLBF"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HW1NDPDLBF'); }); </script>
