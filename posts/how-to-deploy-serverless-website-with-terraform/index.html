<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="How to deploy a serverless website with Terraform" /><meta property="og:locale" content="en" /><meta name="description" content="Terraform is the main open-source tool to create infrastructure as code (IaC) in any cloud provider. In this article, we will review how we can use it to deploy a serverless website on AWS." /><meta property="og:description" content="Terraform is the main open-source tool to create infrastructure as code (IaC) in any cloud provider. In this article, we will review how we can use it to deploy a serverless website on AWS." /><link rel="canonical" href="https://www.playingaws.com//posts/how-to-deploy-serverless-website-with-terraform/" /><meta property="og:url" content="https://www.playingaws.com//posts/how-to-deploy-serverless-website-with-terraform/" /><meta property="og:site_name" content="Playing AWS" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-05T20:53:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to deploy a serverless website with Terraform" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-05T20:53:00+02:00","datePublished":"2023-05-05T20:53:00+02:00","description":"Terraform is the main open-source tool to create infrastructure as code (IaC) in any cloud provider. In this article, we will review how we can use it to deploy a serverless website on AWS.","headline":"How to deploy a serverless website with Terraform","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.playingaws.com//posts/how-to-deploy-serverless-website-with-terraform/"},"url":"https://www.playingaws.com//posts/how-to-deploy-serverless-website-with-terraform/"}</script><title>How to deploy a serverless website with Terraform | Playing AWS</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Playing AWS"><meta name="application-name" content="Playing AWS"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/favicons/favicon.ico" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Playing AWS</a></div><div class="site-subtitle font-italic">Learn, remove barriers and practice</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://www.linkedin.com/in/alejandro-lazaro-chueca/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://github.com/alazaroc" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>How to deploy a serverless website with Terraform</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"> <img src="/assets/img/header.jpeg" alt="header"><h1 data-toc-skip>How to deploy a serverless website with Terraform</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1683312780" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 5, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/alejandro-lazaro-chueca/">Alejandro Lazaro</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2337 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><hr /><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As you already know, creating and managing infrastructure can be a complex and time-consuming process, and fortunately, tools like <strong>Terraform</strong> can simplify this process by allowing you to define your Infrastructure as Code (IaC). In this article, we will explore the basics of Terraform and walk through how to create infrastructure on AWS using it.</p><p>However, this is not my first article about Infrastructure as Code tools.</p><ul><li>If you want to know how to create infrastructure using familiar <strong>programming languages</strong> you can review this article about CDK: <a href="/posts/how-to-add-ci-cd-to-my-cdk-project/" target="_blank">How to create infrastructure with CDK</a><li>If you want to create <strong>serverless applications</strong> on AWS, you can review this other article about SAM: <a href="/posts/how-to-create-serverless-applications-with-sam/" target="_blank">How to create serverless applications with SAM</a></ul><blockquote class="prompt-info"><div><p>I have uploaded the source code used in this article in the following GitHub repository <a href="https://github.com/alazaroc/aws-terraform-serverless-website" target="_blank">https://github.com/alazaroc/aws-terraform-serverless-website</a></p></div></blockquote><h2 id="what-is-terraform"><span class="mr-2">What is Terraform?</span><a href="#what-is-terraform" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://www.terraform.io/" target="_blank">Terraform</a> is an open-source Infrastructure as Code (IaC) software tool created by HashiCorp. It allows you to define and manage your infrastructure using human-readable configuration files that you can version, reuse, and share. You can then use a consistent workflow to provision and manage all of your infrastructure throughout its lifecycle. Terraform supports a wide range of cloud providers, including AWS, Microsoft Azure, and Google Cloud Platform.</p><h2 id="how-terraform-works"><span class="mr-2">How Terraform Works</span><a href="#how-terraform-works" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Terraform uses a declarative configuration language called HashiCorp Configuration Language (HCL).</p><p><strong>In a nutshell:</strong></p><p><a href="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/how-terraform-works.png" class="popup img-link "><img data-src="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/how-terraform-works.png" alt="how-terraform-works" class="lazyload" data-proofer-ignore></a></p><ul><li><strong>Write</strong>: You define your infrastructure in a series of .tf files, which contain the configuration for your resources<li><strong>Plan</strong>: Terraform then uses this configuration to generate an execution plan, which outlines the changes that will be made to your infrastructure.<li><strong>Apply</strong>: Once you have reviewed the execution plan, you can apply it to your infrastructure using the “<code class="language-plaintext highlighter-rouge">terraform apply</code>” command. Terraform will then provision your resources according to the configuration you defined.</ul><h2 id="getting-started-with-terraform"><span class="mr-2">Getting Started with Terraform</span><a href="#getting-started-with-terraform" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To get started with Terraform, you will need to <strong>install it</strong> on your machine. You can download the latest version of Terraform from the official website <a href="https://developer.hashicorp.com/terraform/downloads" target="_blank">here</a>, and if you want to deploy on AWS, you also need AWS CLI.</p><p>Once you have installed Terraform, you can start creating your infrastructure.</p><p>In this section, we will review how Terraform works creating a first example to deploy a simple S3 bucket:</p><ul><li><p>Create a new directory for your Terraform configuration file:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">mkdir my-serverless-website
cd my-serverless-website
</span></pre></table></code></div></div><li><p>Create a new file called “main.tf” and there we are going to include the <code class="language-plaintext highlighter-rouge">AWS provider information</code> with the “us-east-1” region, and one resource of type <code class="language-plaintext highlighter-rouge">aws_s3_bucket</code> to create an S3 bucket with all the default configuration. Remember that the S3 bucket name must be unique globally.</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="p">=</span> <span class="s2">"us-east-1"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="s2">"my-unique-bucket-name-12y398y13489148h"</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p><strong>Initialize</strong> your Terraform configuration.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">terraform init
</span></pre></table></code></div></div><p>When you run <code class="language-plaintext highlighter-rouge">terraform init</code>, Terraform downloads and installs the necessary provider plugins and modules required for your configuration. It also initializes the backend, which is the storage location for your <code class="language-plaintext highlighter-rouge">Terraform state file</code>. The state file is used to store the current state of your infrastructure, and it is used by Terraform to plan and apply changes to your infrastructure.</p><li><p>Generate an execution <strong>plan</strong> (optional):</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">terraform plan
</span></pre></table></code></div></div><p>This command generates an execution plan based on the configuration in your <code class="language-plaintext highlighter-rouge">main.tf</code> file, and let you check what is going to be deployed.</p><li><p><strong>Apply</strong> the execution plan to deploy on AWS:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">terraform apply
</span></pre></table></code></div></div><p>When you run <code class="language-plaintext highlighter-rouge">terraform apply</code>, Terraform compares the current state of your infrastructure with the desired state defined in your configuration. It then creates, modifies, or deletes resources as necessary to bring your infrastructure into the desired state. In our example, a new S3 bucket will be deployed.</p><li><p>Now, the AWS resources have been created. Let’s check it accessing the AWS S3 service to access the new resource created by Terraform:</p><p><a href="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-s3.png" class="popup img-link "><img data-src="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-s3.png" alt="terraform-s3" class="lazyload" data-proofer-ignore></a></p></ul><blockquote class="prompt-tip"><div><p>We already know how to deploy AWS resources with Terraform, so in the following section, we will evolve the initial example to deploy three serverless websites using S3 bucket.</p></div></blockquote><h2 id="how-to-deploy-a-serverless-website-with-terraform"><span class="mr-2">How to deploy a serverless website with Terraform</span><a href="#how-to-deploy-a-serverless-website-with-terraform" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We have an AWS S3 bucket deployed, and now we are going to use it to host a serverless website. There are different ways to do it, and we are going to evolve the S3 bucket to create a serverless static website.</p><p>This is what we are going to build:</p><p><a href="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-website.png" class="popup img-link "><img data-src="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-website.png" alt="terraform-website" class="lazyload" data-proofer-ignore></a></p><ul><li><strong>v1.1</strong>: public S3 bucket<ul><li><strong>Advantage</strong>: easy to implement<li><strong>Disadvantages</strong>: no custom domain, no aligned with security best practices (public bucket), no cache for static files</ul><li><strong>v1.2</strong>: public S3 as <code class="language-plaintext highlighter-rouge">Static website hosting</code><ul><li><strong>Advantages</strong>: easy to implement, index document and error page, redirection rules<li><strong>Disadvantages</strong>: not aligned with security best practices (public bucket), no cache for static files, Amazon S3 website endpoints do not support HTTPS (if you want to use HTTPS, you can use Amazon CloudFront to serve a static website hosted on Amazon S3)</ul><li><strong>v2</strong>: CloudFront distribution + private S3 bucket<ul><li><strong>Advantage</strong>: easy to implement, private s3 bucket, cache for static files<li><strong>Disadvantages</strong>: auto-generated domain name</ul><li><strong>v3</strong>: Route53 + ACM + CloudFront Distribution + private S3 bucket + optionally Lambda Edge<ul><li><strong>Advantages</strong>: custom domain name using AWS managed certificates, private s3 bucket, cache for static files<li><strong>Disadvantages</strong>: more complex to implement</ul></ul><p>In these examples, we are going to deploy a static website based on an <code class="language-plaintext highlighter-rouge">index.html</code> file with this content:</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>This is my serverless website
</pre></table></code></div></div><h3 id="v11-public-s3-bucket"><span class="mr-2">v1.1: public S3 bucket</span><a href="#v11-public-s3-bucket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this version 1.1 we are going to expose the S3 bucket publicly so any person can access the <code class="language-plaintext highlighter-rouge">index.html</code> file using the public S3 endpoint.</p><ul><li><strong>Advantage</strong>:<ul><li>easy to implement</ul><li><strong>Disadvantages</strong>:<ul><li>no custom domain<li>no aligned with security best practices (public bucket)<li>no cache for static files</ul></ul><blockquote class="prompt-warning"><div><p>This solution is not aligned with security best practices because it expose an S3 bucket publicly.</p></div></blockquote><p>Update the file “main.tf” with the following content:</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="k">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="p">=</span> <span class="s2">"us-east-1"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="s2">"my-unique-bucket-name-12y398y13489148h"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_object"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span>       <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">key</span>          <span class="p">=</span> <span class="s2">"index.html"</span>
  <span class="nx">source</span>       <span class="p">=</span> <span class="s2">"index.html"</span>
  <span class="nx">content_type</span> <span class="p">=</span> <span class="s2">"text/html"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_account_public_access_block"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">block_public_acls</span>   <span class="p">=</span> <span class="kc">false</span>
  <span class="nx">block_public_policy</span> <span class="p">=</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_bucket_public_access_block"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">block_public_acls</span>       <span class="p">=</span> <span class="kc">false</span>
  <span class="nx">block_public_policy</span>     <span class="p">=</span> <span class="kc">false</span>
  <span class="nx">ignore_public_acls</span>      <span class="p">=</span> <span class="kc">false</span>
  <span class="nx">restrict_public_buckets</span> <span class="p">=</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_bucket_policy"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">policy</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="p">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="p">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Sid</span> <span class="p">=</span> <span class="s2">"PublicReadGetObject"</span>
        <span class="nx">Effect</span> <span class="p">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="p">=</span> <span class="s2">"*"</span>
        <span class="nx">Action</span> <span class="p">=</span> <span class="p">[</span>
          <span class="s2">"s3:GetObject"</span><span class="p">,</span>
          <span class="s2">"s3:ListBucket"</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="nx">Resource</span> <span class="p">=</span> <span class="p">[</span>
          <span class="s2">"</span><span class="k">${</span><span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">arn</span><span class="k">}</span><span class="s2">"</span><span class="p">,</span>
          <span class="s2">"</span><span class="k">${</span><span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">arn</span><span class="k">}</span><span class="s2">/*"</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now, execute the terraform apply command: <code class="language-plaintext highlighter-rouge">terraform apply --auto-approve</code></p><p>Then, open a private window in your browser and access the <code class="language-plaintext highlighter-rouge">index.html</code> content using the public endpoint of our S3 bucket. If you have executed the code before, it will be the following URL: <a href="https://my-unique-bucket-name-12y398y13489148h.s3.amazonaws.com/index.html" target="_blank">https://my-unique-bucket-name-12y398y13489148h.s3.amazonaws.com/index.html</a></p><p><a href="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-s3-website.png" class="popup img-link "><img data-src="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-s3-website.png" alt="s3-website" class="lazyload" data-proofer-ignore></a></p><h3 id="v12-static-website-hosting-using-s3"><span class="mr-2">v1.2: Static website hosting using S3</span><a href="#v12-static-website-hosting-using-s3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this version, similar to the previous one, we still have exposed the S3 bucket publicly but we will enable the static website hosting feature of S3.</p><ul><li><strong>Advantages</strong>:<ul><li>easy to implement<li>static website includes the configuration of an index document, an error page and also redirection rules</ul><li><strong>Disadvantages</strong>:<ul><li>not aligned with security best practices (public bucket)<li>no cache for static files<li>Amazon S3 website endpoints <strong>do not support HTTPS</strong> (if you want to use HTTPS, you can use Amazon CloudFront to serve a static website hosted on Amazon S3)</ul></ul><blockquote class="prompt-warning"><div><p>This solution is not aligned with security best practices because it expose an S3 bucket publicly.</p></div></blockquote><p>Using the content of the “main.tf” showed in the previous v1.1 example, add at the end of the document the following lines:</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">resource</span> <span class="s2">"aws_s3_bucket_website_configuration"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">index_document</span> <span class="p">{</span>
    <span class="nx">suffix</span> <span class="p">=</span> <span class="s2">"index.html"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now, execute the terraform apply command: <code class="language-plaintext highlighter-rouge">terraform apply --auto-approve</code></p><p>Then, open a private window in your browser and access through the static website to the <code class="language-plaintext highlighter-rouge">index.html</code> content: <a href="http://my-unique-bucket-name-12y398y13489148h.s3-website-us-east-1.amazonaws.com/" target="_blank">http://my-unique-bucket-name-12y398y13489148h.s3-website-us-east-1.amazonaws.com/</a></p><p><a href="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-s3-static-website.png" class="popup img-link "><img data-src="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-s3-static-website.png" alt="s3-static-website" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-warning"><div><p>If you didn’t realize before, look that we are using HTTP, not HTTPS. S3 static website don’t support HTTPS.</p></div></blockquote><h3 id="v2-cloudfront-distribution--private-s3-bucket"><span class="mr-2">v2: CloudFront Distribution + private S3 bucket</span><a href="#v2-cloudfront-distribution--private-s3-bucket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this version, we are going to change the bucket to private again (and also, we are going to enable again the <code class="language-plaintext highlighter-rouge">Block Public Access settings for this account</code> feature of S3), and we are going to create a CloudFront Distribution connected with the private S3 bucket. So, we are going to access the S3 bucket using the CloudFront distribution.</p><ul><li><strong>Advantage</strong>:<ul><li>easy to implement<li>private s3 bucket (aligned with the security best practices)<li>includes cache for static files</ul><li><strong>Disadvantages</strong>:<ul><li>auto-generated domain name (by CloudFront)</ul></ul><p>Replace the “main.tf” content with the following lines:</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre><td class="rouge-code"><pre><span class="k">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="p">=</span> <span class="s2">"us-east-1"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="s2">"my-unique-bucket-name-12y398y13489148h"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_account_public_access_block"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">block_public_acls</span>   <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">block_public_policy</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">ignore_public_acls</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">restrict_public_buckets</span> <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_object"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span>       <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">key</span>          <span class="p">=</span> <span class="s2">"index.html"</span>
  <span class="nx">source</span>       <span class="p">=</span> <span class="s2">"index.html"</span>
  <span class="nx">content_type</span> <span class="p">=</span> <span class="s2">"text/html"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"cdn_static_site"</span> <span class="p">{</span>
  <span class="nx">enabled</span>             <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">is_ipv6_enabled</span>     <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">default_root_object</span> <span class="p">=</span> <span class="s2">"index.html"</span>
  <span class="nx">comment</span>             <span class="p">=</span> <span class="s2">"my cloudfront in front of the s3 bucket"</span>

  <span class="nx">origin</span> <span class="p">{</span>
    <span class="nx">domain_name</span>              <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">bucket_regional_domain_name</span>
    <span class="nx">origin_id</span>                <span class="p">=</span> <span class="s2">"my-s3-origin"</span>
    <span class="nx">origin_access_control_id</span> <span class="p">=</span> <span class="nx">aws_cloudfront_origin_access_control</span><span class="p">.</span><span class="nx">default</span><span class="p">.</span><span class="nx">id</span>
  <span class="p">}</span>

  <span class="nx">default_cache_behavior</span> <span class="p">{</span>
    <span class="nx">min_ttl</span>                <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">default_ttl</span>            <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">max_ttl</span>                <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">viewer_protocol_policy</span> <span class="p">=</span> <span class="s2">"redirect-to-https"</span>

    <span class="nx">allowed_methods</span>  <span class="p">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">]</span>
    <span class="nx">cached_methods</span>   <span class="p">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">target_origin_id</span> <span class="p">=</span> <span class="s2">"my-s3-origin"</span>

    <span class="nx">forwarded_values</span> <span class="p">{</span>
      <span class="nx">query_string</span> <span class="p">=</span> <span class="kc">false</span>
      <span class="nx">cookies</span> <span class="p">{</span>
        <span class="nx">forward</span> <span class="p">=</span> <span class="s2">"none"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">restrictions</span> <span class="p">{</span>
    <span class="nx">geo_restriction</span> <span class="p">{</span>
      <span class="nx">locations</span>        <span class="p">=</span> <span class="p">[]</span>
      <span class="nx">restriction_type</span> <span class="p">=</span> <span class="s2">"none"</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">viewer_certificate</span> <span class="p">{</span>
    <span class="nx">cloudfront_default_certificate</span> <span class="p">=</span> <span class="kc">true</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_cloudfront_origin_access_control"</span> <span class="s2">"default"</span> <span class="p">{</span>
  <span class="nx">name</span>                              <span class="p">=</span> <span class="s2">"cloudfront OAC"</span>
  <span class="nx">description</span>                       <span class="p">=</span> <span class="s2">"description of OAC"</span>
  <span class="nx">origin_access_control_origin_type</span> <span class="p">=</span> <span class="s2">"s3"</span>
  <span class="nx">signing_behavior</span>                  <span class="p">=</span> <span class="s2">"always"</span>
  <span class="nx">signing_protocol</span>                  <span class="p">=</span> <span class="s2">"sigv4"</span>
<span class="p">}</span>

<span class="k">output</span> <span class="s2">"cloudfront_url"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="nx">aws_cloudfront_distribution</span><span class="p">.</span><span class="nx">cdn_static_site</span><span class="p">.</span><span class="nx">domain_name</span>
<span class="p">}</span>

<span class="k">data</span> <span class="s2">"aws_iam_policy_document"</span> <span class="s2">"website_bucket"</span> <span class="p">{</span>
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">actions</span>   <span class="p">=</span> <span class="p">[</span><span class="s2">"s3:GetObject"</span><span class="p">]</span>
    <span class="nx">resources</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"</span><span class="k">${</span><span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">arn</span><span class="k">}</span><span class="s2">/*"</span><span class="p">]</span>
    <span class="nx">principals</span> <span class="p">{</span>
      <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"Service"</span>
      <span class="nx">identifiers</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"cloudfront.amazonaws.com"</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="nx">condition</span> <span class="p">{</span>
      <span class="nx">test</span>     <span class="p">=</span> <span class="s2">"StringEquals"</span>
      <span class="k">variable</span> <span class="p">=</span> <span class="s2">"aws:SourceArn"</span>
      <span class="nx">values</span>   <span class="p">=</span> <span class="p">[</span><span class="nx">aws_cloudfront_distribution</span><span class="p">.</span><span class="nx">cdn_static_site</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_bucket_policy"</span> <span class="s2">"website_bucket_policy"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">policy</span> <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_iam_policy_document</span><span class="p">.</span><span class="nx">website_bucket</span><span class="p">.</span><span class="nx">json</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Now, execute the terraform apply command: <code class="language-plaintext highlighter-rouge">terraform apply --auto-approve</code></p><p>Then, open a private window in your browser and access the <code class="language-plaintext highlighter-rouge">index.html</code> content using the CloudFront DNS. The execution of the terraform template has as output the URL of the CloudFront Distribution.</p><p><a href="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-cloudfront.png" class="popup img-link "><img data-src="/assets/img/posts/2023-05-05-how-to-deploy-serverless-website-with-terraform/terraform-cloudfront.png" alt="terraform-cloudfront" class="lazyload" data-proofer-ignore></a></p><blockquote class="prompt-info"><div><p>Now, the S3 bucket is private, so if you access to the public endpoint of S3 trying to get the <code class="language-plaintext highlighter-rouge">index.html</code> file you will receive an error</p></div></blockquote><h3 id="v3-route53--acm--cloudfront-distribution--private-s3-bucket"><span class="mr-2">v3: Route53 + ACM + CloudFront Distribution + private S3 bucket</span><a href="#v3-route53--acm--cloudfront-distribution--private-s3-bucket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In the last example, we will use our domain (registered in Route53) and we will create a certificate using ACM.</p><ul><li><strong>Requirement</strong>:<ul><li>Required a custom domain</ul><li><strong>Advantages</strong>:<ul><li>custom domain name using AWS managed certificates<li>private s3 bucket (aligned with the security best practices)<li>includes cache for static files</ul><li><strong>Disadvantages</strong>:<ul><li>more complex to implement</ul></ul><blockquote class="prompt-warning"><div><p>To be able to run this example you need your own domain (example.com) and you have to register it in Route53 service. If you don’t have it you can buy a new domain in the Route53 server but it will cost you about 10 dollars per year.</p></div></blockquote><p>These are the changes that you have to do in the previous “main.tf” file:</p><ul><li><p>Update in your CloudFront Distribution resource <code class="language-plaintext highlighter-rouge">aws_cloudfront_distribution</code> the following, (where <code class="language-plaintext highlighter-rouge">${var.domain_name_simple}</code> is for example <code class="language-plaintext highlighter-rouge">example.com</code>):</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  <span class="nx">viewer_certificate</span> <span class="p">{</span>
    <span class="nx">cloudfront_default_certificate</span> <span class="p">=</span> <span class="kc">true</span> 
  <span class="p">}</span>
</pre></table></code></div></div><p>replacing it for this:</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>  <span class="nx">viewer_certificate</span> <span class="p">{</span>
    <span class="nx">acm_certificate_arn</span>      <span class="p">=</span> <span class="nx">aws_acm_certificate</span><span class="p">.</span><span class="nx">cert</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">ssl_support_method</span>       <span class="p">=</span> <span class="s2">"sni-only"</span>
    <span class="nx">minimum_protocol_version</span> <span class="p">=</span> <span class="s2">"TLSv1.2_2021"</span>
  <span class="p">}</span>
    
  <span class="nx">aliases</span> <span class="err">=</span> <span class="p">[</span>
    <span class="kd">var</span><span class="p">.</span><span class="nx">domain_name_simple</span><span class="p">,</span>
    <span class="kd">var</span><span class="p">.</span><span class="nx">domain_name</span>
  <span class="p">]</span>
</pre></table></code></div></div><li><p>Next, add the following lines:</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre><td class="rouge-code"><pre><span class="k">resource</span> <span class="s2">"aws_acm_certificate"</span> <span class="s2">"cert"</span> <span class="p">{</span>
  <span class="k">provider</span>                  <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">use_default_region</span>
  <span class="nx">domain_name</span>               <span class="p">=</span> <span class="s2">"*.</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">domain_name_simple</span><span class="k">}</span><span class="s2">"</span>
  <span class="nx">validation_method</span>         <span class="p">=</span> <span class="s2">"DNS"</span>
  <span class="nx">subject_alternative_names</span> <span class="p">=</span> <span class="p">[</span><span class="kd">var</span><span class="p">.</span><span class="nx">domain_name_simple</span><span class="p">]</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">create_before_destroy</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">data</span> <span class="s2">"aws_route53_zone"</span> <span class="s2">"zone"</span> <span class="p">{</span>
  <span class="k">provider</span>     <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">use_default_region</span>
  <span class="nx">name</span>         <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">domain_name_simple</span>
  <span class="nx">private_zone</span> <span class="p">=</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_route53_record"</span> <span class="s2">"cert_validation"</span> <span class="p">{</span>
  <span class="k">provider</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">use_default_region</span>
  <span class="nx">for_each</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">dvo</span> <span class="nx">in</span> <span class="nx">aws_acm_certificate</span><span class="p">.</span><span class="nx">cert</span><span class="p">.</span><span class="nx">domain_validation_options</span> <span class="err">:</span> <span class="nx">dvo</span><span class="p">.</span><span class="nx">domain_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="nx">name</span>   <span class="p">=</span> <span class="nx">dvo</span><span class="p">.</span><span class="nx">resource_record_name</span>
      <span class="nx">record</span> <span class="p">=</span> <span class="nx">dvo</span><span class="p">.</span><span class="nx">resource_record_value</span>
      <span class="nx">type</span>   <span class="p">=</span> <span class="nx">dvo</span><span class="p">.</span><span class="nx">resource_record_type</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">allow_overwrite</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">name</span>            <span class="p">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">records</span>         <span class="p">=</span> <span class="p">[</span><span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">record</span><span class="p">]</span>
  <span class="nx">type</span>            <span class="p">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">type</span>
  <span class="nx">zone_id</span>         <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_route53_zone</span><span class="p">.</span><span class="nx">zone</span><span class="p">.</span><span class="nx">zone_id</span>
  <span class="nx">ttl</span>             <span class="p">=</span> <span class="mi">60</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_acm_certificate_validation"</span> <span class="s2">"cert"</span> <span class="p">{</span>
  <span class="k">provider</span>                <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">use_default_region</span>
  <span class="nx">certificate_arn</span>         <span class="p">=</span> <span class="nx">aws_acm_certificate</span><span class="p">.</span><span class="nx">cert</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">validation_record_fqdns</span> <span class="p">=</span> <span class="p">[</span><span class="nx">for</span> <span class="nx">record</span> <span class="nx">in</span> <span class="nx">aws_route53_record</span><span class="p">.</span><span class="nx">cert_validation</span> <span class="err">:</span> <span class="nx">record</span><span class="p">.</span><span class="nx">fqdn</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_route53_record"</span> <span class="s2">"www"</span> <span class="p">{</span>
  <span class="nx">zone_id</span> <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_route53_zone</span><span class="p">.</span><span class="nx">zone</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">name</span>    <span class="p">=</span> <span class="s2">"www.</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">domain_name_simple</span><span class="k">}</span><span class="s2">"</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="s2">"A"</span>

  <span class="nx">alias</span> <span class="p">{</span>
    <span class="nx">name</span>                   <span class="p">=</span> <span class="nx">aws_cloudfront_distribution</span><span class="p">.</span><span class="nx">cdn_static_site</span><span class="p">.</span><span class="nx">domain_name</span>
    <span class="nx">zone_id</span>                <span class="p">=</span> <span class="nx">aws_cloudfront_distribution</span><span class="p">.</span><span class="nx">cdn_static_site</span><span class="p">.</span><span class="nx">hosted_zone_id</span>
    <span class="nx">evaluate_target_health</span> <span class="p">=</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_route53_record"</span> <span class="s2">"apex"</span> <span class="p">{</span>
  <span class="nx">zone_id</span> <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_route53_zone</span><span class="p">.</span><span class="nx">zone</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">name</span>    <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">domain_name_simple</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="s2">"A"</span>

  <span class="nx">alias</span> <span class="p">{</span>
    <span class="nx">name</span>                   <span class="p">=</span> <span class="nx">aws_cloudfront_distribution</span><span class="p">.</span><span class="nx">cdn_static_site</span><span class="p">.</span><span class="nx">domain_name</span>
    <span class="nx">zone_id</span>                <span class="p">=</span> <span class="nx">aws_cloudfront_distribution</span><span class="p">.</span><span class="nx">cdn_static_site</span><span class="p">.</span><span class="nx">hosted_zone_id</span>
    <span class="nx">evaluate_target_health</span> <span class="p">=</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>Now, execute the terraform apply command: <code class="language-plaintext highlighter-rouge">terraform apply --auto-approve</code></p><li><p>Finally, open a private window in your browser and access your registered domain: <a href="https://example.com" target="_blank">https://example.com</a></p></ul><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In this article, we have explored the basics of Terraform and walked through how to create infrastructure with different examples. With Terraform, you can define your infrastructure as code and automate the process of creating and updating your resources.</p><p>This example is based on the code I have created to deploy my own blog <a href="https://playingaws.com" target="_blank">https://playingaws.com</a> using <code class="language-plaintext highlighter-rouge">Route53 + ACM + CloudFront Distribution + private S3 bucket</code>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/iac/'>IaC</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/how-to/" class="post-tag no-text-decoration" >how-to</a> <a href="/tags/iac/" class="post-tag no-text-decoration" >iac</a> <a href="/tags/terraform/" class="post-tag no-text-decoration" >terraform</a> <a href="/tags/github/" class="post-tag no-text-decoration" >github</a> <a href="/tags/serverless/" class="post-tag no-text-decoration" >serverless</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How%20to%20deploy%20a%20serverless%20website%20with%20Terraform%20-%20Playing%20AWS&url=https%3A%2F%2Fwww.playingaws.com%2F%2Fposts%2Fhow-to-deploy-serverless-website-with-terraform%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.playingaws.com%2F%2Fposts%2Fhow-to-deploy-serverless-website-with-terraform%2F&text=How%20to%20deploy%20a%20serverless%20website%20with%20Terraform%20-%20Playing%20AWS" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.playingaws.com%2F%2Fposts%2Fhow-to-deploy-serverless-website-with-terraform%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading"></div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/aws-open-source-tools/">Getting started with AWS open-source tools</a><li><a href="/posts/getting-started-with-aws-security/">Getting Started with AWS Security</a><li><a href="/posts/how-to-improve-your-account-security/">How to improve your account security</a></ul></div><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/challenge-data-certification-in-30-days/">Challenge: 'AWS Certified Data Analytics Specialty' in 30 days</a><li><a href="/posts/10-steps-to-prepare-any-aws-certification/">10 steps to prepare any AWS certification</a><li><a href="/posts/aws-control-tower-deep-dive/">AWS Control Tower Deep Dive</a><li><a href="/posts/the-technology-behind-this-blog/">How I decided on the technology behind the blog</a><li><a href="/posts/multi-account-approach/">Getting started with AWS Multi-account approach</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/how-to/">how-to</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/iac/">iac</a> <a class="post-tag" href="/tags/getting-started/">getting-started</a> <a class="post-tag" href="/tags/cdk/">cdk</a> <a class="post-tag" href="/tags/deep-dive/">deep dive</a> <a class="post-tag" href="/tags/serverless/">serverless</a> <a class="post-tag" href="/tags/certification/">certification</a> <a class="post-tag" href="/tags/open-source/">open-source</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/how-to-create-serverless-applications-with-sam/"><div class="card-body"> <em class="small" data-ts="1649509620" data-df="ll" > Apr 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to create serverless applications with SAM</h3><div class="text-muted small"><p> Introduction The AWS Serverless Application Model (AWS SAM) is an open-source framework that you can use to build serverless applications on AWS. A serverless application is more than just a La...</p></div></div></a></div><div class="card"> <a href="/posts/how-to-add-ci-cd-to-my-sam-project/"><div class="card-body"> <em class="small" data-ts="1649580780" data-df="ll" > Apr 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to add CI/CD to my SAM project</h3><div class="text-muted small"><p> Introduction This is the second article of SAM. In this other article I had explained how to create serverless applications with SAM, and there I explained all the basic SAM information, so y...</p></div></div></a></div><div class="card"> <a href="/posts/how-to-create-serverless-applications-with-cdk-and-sam/"><div class="card-body"> <em class="small" data-ts="1650912300" data-df="ll" > Apr 25, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to create serverless applications with CDK and SAM</h3><div class="text-muted small"><p> TLDR A serverless application is more than just a Lambda Function. It is a combination of Lambda functions, event sources, APIs, databases, and other resources that work together to perform t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/aws-open-source-tools-code/" class="btn btn-outline-primary" prompt="Older"><p>How open source tools can help you with your code</p></a> <a href="/posts/aws-waf-web-application-firewall-deep-dive/" class="btn btn-outline-primary" prompt="Newer"><p>AWS WAF (Web Application Firewall): Deep Dive</p></a></div><script type="text/javascript"> document.getElementsByClassName("post-content")[0].innerHTML += '<h2 id="comment-this-post">Comment this post</h2>'; document.getElementsByClassName("post-content")[0].innerHTML += '<p>I hope this content has been relevant to you. To help me improve it would be helpful if you could give me your honest feedback.</p>'; $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "alazaroc/blog-web", "data-repo-id": "R_kgDOHA-hqQ", "data-category": "Announcements", "data-category-id": "DIC_kwDOHA-hqc4CT2E5", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementsByClassName("post-content")[0].appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/how-to/">how-to</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/iac/">iac</a> <a class="post-tag" href="/tags/getting-started/">getting-started</a> <a class="post-tag" href="/tags/cdk/">cdk</a> <a class="post-tag" href="/tags/deep-dive/">deep dive</a> <a class="post-tag" href="/tags/serverless/">serverless</a> <a class="post-tag" href="/tags/certification/">certification</a> <a class="post-tag" href="/tags/open-source/">open-source</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://www.linkedin.com/in/alejandro-lazaro-chueca/">Alejandro Lazaro</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Deployed with AWS resources.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-HW1NDPDLBF"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HW1NDPDLBF'); }); </script>
